{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Fashion Wear - Premium Style Collection</title>
    
    <!-- Local CSS files -->
    <link rel="stylesheet" href="{% static 'shop/styles.css' %}">
    <link rel="stylesheet" href="{% static 'shop/responsive.css' %}">
    
    <!-- External CSS files -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
   
   <style>
      /* Global Styles */
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Inter', sans-serif;
          line-height: 1.6;
          color: #333;
          background: #fafafa;
          overflow-x: hidden;
      }

      h1, h2, h3, h4, h5, h6 {
          font-family: 'Playfair Display', serif;
          font-weight: 600;
      }

      /* Background Blur Overlay */
      .blur-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(10px);
          z-index: 1040;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
      }

      .blur-overlay.active {
          opacity: 1;
          visibility: visible;
      }

      /* Enhanced Navbar Styles */
      .navbar {
          background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%) !important;
          box-shadow: 0 4px 30px rgba(0,0,0,0.15);
          border-bottom: 1px solid rgba(255,255,255,0.1);
          padding: 1.2rem 0;
          position: sticky;
          top: 0;
          z-index: 1050;
          backdrop-filter: blur(10px);
      }

      .navbar-brand {
          font-family: 'Playfair Display', serif !important;
          font-size: 2rem !important;
          font-weight: 700 !important;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          text-decoration: none;
          transition: all 0.3s ease;
      }

      .navbar-brand:hover {
          transform: scale(1.05);
      }

      .nav-actions {
          display: flex;
          align-items: center;
          gap: 1rem;
          margin-left: auto;
          margin-right: 2rem;
      }

      /* Enhanced Nav Action Buttons */
      .cart-icon, .add-product-btn {
          background: rgba(255,255,255,0.1);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 12px;
          padding: 10px 18px;
          color: #fff;
          text-decoration: none;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 0.9rem;
          font-weight: 500;
          backdrop-filter: blur(10px);
          white-space: nowrap;
      }

      .cart-icon:hover, .add-product-btn:hover {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: #fff;
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
          border-color: transparent;
      }

      /* AI Search Bar Styles */
      .ai-search-container {
          position: relative;
          display: flex;
          align-items: center;
      }

      .ai-search-toggle {
          background: rgba(255,255,255,0.1);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 25px;
          padding: 8px 16px;
          color: #fff;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.9rem;
          backdrop-filter: blur(10px);
          min-width: 180px;
      }

      .ai-search-toggle:hover {
          background: rgba(255,255,255,0.15);
          border-color: rgba(102, 126, 234, 0.5);
          transform: translateY(-1px);
      }

      .ai-search-toggle i {
          font-size: 1rem;
          color: #667eea;
      }

      /* AI Search Panel - Slides from top */
      .ai-search-panel {
          position: fixed;
          top: 0;
          left: 0;
          height: 100vh;
          width: 100%;
          background: #fff;
          z-index: 1060;
          transform: translateY(-100%);
          transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
          box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      }

      .ai-search-panel.active {
          transform: translateY(0);
      }

      .ai-search-content {
          max-width: 800px;
          margin: 0 auto;
          padding: 60px 20px 40px;
      }

      .ai-search-header {
          text-align: center;
          margin-bottom: 30px;
      }

      .ai-search-header h3 {
          font-size: 2rem;
          margin-bottom: 10px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
      }

      .ai-search-header p {
          color: #666;
          font-size: 1.1rem;
      }

      .ai-search-input-container {
          position: relative;
          margin-bottom: 30px;
      }

      .ai-search-input {
          width: 100%;
          padding: 20px 60px 20px 20px;
          font-size: 1.2rem;
          border: 2px solid #e9ecef;
          border-radius: 50px;
          outline: none;
          transition: all 0.3s ease;
          box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      }

      .ai-search-input:focus {
          border-color: #667eea;
          box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2);
      }

      .ai-search-input::placeholder {
          color: #adb5bd;
      }

      .ai-search-send {
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: none;
          border-radius: 50%;
          width: 45px;
          height: 45px;
          color: #fff;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .ai-search-send:hover {
          transform: translateY(-50%) scale(1.1);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .ai-quick-actions {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 30px;
      }

      .quick-action-btn {
          padding: 15px 20px;
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 12px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
          font-weight: 500;
      }

      .quick-action-btn:hover {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: #fff;
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      /* AI Response Area */
      .ai-response-container {
          margin-top: 20px;
          display: none;
      }

      .ai-response-container.active {
          display: block;
          animation: fadeInUp 0.5s ease;
      }

      @keyframes fadeInUp {
          from {
              opacity: 0;
              transform: translateY(20px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .ai-response-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 15px;
          color: #667eea;
          font-weight: 600;
      }

      .ai-response-content {
          background: #f8f9fa;
          border: 2px solid #e9ecef;
          border-radius: 15px;
          padding: 20px;
          max-height: 200px;
          overflow-y: auto;
          font-size: 1rem;
          line-height: 1.6;
          color: #333;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
          position: relative;
      }

      .ai-response-content::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 3px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 15px 15px 0 0;
      }

      .ai-typing {
          display: flex;
          align-items: center;
          gap: 8px;
          color: #667eea;
          font-style: italic;
      }

      .ai-typing-dots {
          display: flex;
          gap: 4px;
      }

      .ai-typing-dots span {
          width: 6px;
          height: 6px;
          background: #667eea;
          border-radius: 50%;
          animation: typingDots 1.4s infinite ease-in-out;
      }

      .ai-typing-dots span:nth-child(1) {
          animation-delay: -0.32s;
      }

      .ai-typing-dots span:nth-child(2) {
          animation-delay: -0.16s;
      }

      @keyframes typingDots {
          0%, 80%, 100% {
              transform: scale(0.8);
              opacity: 0.5;
          }
          40% {
              transform: scale(1);
              opacity: 1;
          }
      }

      .ai-search-close {
          position: absolute;
          top: 20px;
          right: 20px;
          background: none;
          border: none;
          font-size: 1.5rem;
          color: #666;
          cursor: pointer;
          padding: 10px;
          border-radius: 50%;
          transition: all 0.3s ease;
      }

      .ai-search-close:hover {
          background: #f8f9fa;
          color: #333;
          transform: rotate(90deg);
      }

      /* Enhanced Feature Boxes */
      .feature-box {
          background: #fff;
          border-radius: 16px;
          box-shadow: 0 8px 30px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
          border: 1px solid #f1f3f4;
          position: relative;
          overflow: hidden;
      }

      .feature-box::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          transform: scaleX(0);
          transition: transform 0.3s ease;
      }

      .feature-box:hover {
          transform: translateY(-8px);
          box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      }

      .feature-box:hover::before {
          transform: scaleX(1);
      }

      .feature-box i {
          color: #667eea;
          transition: all 0.3s ease;
      }

      .feature-box:hover i {
          transform: scale(1.1);
          color: #764ba2;
      }

      /* Enhanced Headlines */
      .headline h2 {
          position: relative;
          display: inline-block;
          color: #333;
          font-weight: 600;
          font-size: 2.5rem;
      }

      .headline h2::after {
          content: '';
          position: absolute;
          bottom: -15px;
          left: 50%;
          transform: translateX(-50%);
          width: 80px;
          height: 4px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 2px;
      }

      /* Product Cards */
      .product-card {
          background: white;
          border-radius: 25px;
          overflow: hidden;
          box-shadow: 0 15px 35px rgba(0,0,0,0.1);
          transition: all 0.3s ease;
          cursor: pointer;
          position: relative;
          border: 1px solid #f1f3f4;
          margin-bottom: 30px;
      }

      .product-card:hover {
          transform: translateY(-20px) scale(1.02);
          box-shadow: 0 30px 60px rgba(0,0,0,0.2);
      }

      .product-image {
          height: 250px;
          background: linear-gradient(45deg, #f8f9fa, #e9ecef);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 4rem;
          color: #667eea;
          background-size: cover;
          background-position: center;
          position: relative;
          overflow: hidden;
      }

      .product-info {
          padding: 30px;
          position: relative;
          z-index: 2;
      }

      .product-category {
          color: #667eea;
          font-size: 0.9rem;
          font-weight: 600;
          margin-bottom: 8px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }

      .product-name {
          font-size: 1.5rem;
          font-weight: 700;
          color: #333;
          margin-bottom: 12px;
          font-family: 'Playfair Display', serif;
      }

      .product-price {
          font-size: 1.3rem;
          font-weight: 700;
          color: #667eea;
          margin-bottom: 15px;
      }

      .product-id {
          font-size: 0.8rem;
          color: #999;
          margin-bottom: 10px;
      }

      .product-description {
          color: #666;
          line-height: 1.5;
          margin-bottom: 20px;
      }

      .add-to-cart {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 100%;
      }

      .add-to-cart:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
          .nav-actions {
              display: none;
          }
          
          .headline h2 {
              font-size: 2rem;
          }
          
          .navbar-brand {
              font-size: 1.5rem !important;
          }
      }
   </style>
</head>

<body>
    <!-- Background Blur Overlay -->
    <div class="blur-overlay" id="blurOverlay" onclick="closeAISearch()"></div>

    <!-- AI Search Panel -->
    <div class="ai-search-panel" id="aiSearchPanel">
        <button class="ai-search-close" onclick="closeAISearch()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="ai-search-content">
            <div class="ai-search-header">
                <h3>AI Fashion Assistant</h3>
                <p>Ask me anything about fashion trends, styling tips, or product recommendations</p>
            </div>
            
            <div class="ai-search-input-container">
                <input type="text" class="ai-search-input" id="aiSearchInput" placeholder="Ask me about fashion trends, styling tips, or find specific products...">
                <button class="ai-search-send" onclick="sendAIMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="ai-quick-actions">
                <div class="quick-action-btn" onclick="quickSearch('trending fashion styles 2024')">
                    <i class="fas fa-fire" style="margin-right: 8px; color: #667eea;"></i>
                    Trending Styles 2024
                </div>
                <div class="quick-action-btn" onclick="quickSearch('size guide and fitting tips')">
                    <i class="fas fa-ruler" style="margin-right: 8px; color: #667eea;"></i>
                    Size Guide & Fitting
                </div>
                <div class="quick-action-btn" onclick="quickSearch('outfit ideas and combinations')">
                    <i class="fas fa-palette" style="margin-right: 8px; color: #667eea;"></i>
                    Outfit Ideas
                </div>
                <div class="quick-action-btn" onclick="quickSearch('return and exchange policy')">
                    <i class="fas fa-undo" style="margin-right: 8px; color: #667eea;"></i>
                    Return Policy
                </div>
            </div>
            
            <!-- AI Response Area -->
            <div class="ai-response-container" id="aiResponseContainer">
                <div class="ai-response-header">
                    <i class="fas fa-robot"></i>
                    <span>AI Fashion Assistant Response</span>
                </div>
                <div class="ai-response-content" id="aiResponseContent">
                    <!-- AI responses will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Fashion Wear</a>
            <div class="nav-actions">
                <!-- AI Search Bar Toggle -->
                <div class="ai-search-container">
                    <div class="ai-search-toggle" onclick="toggleAISearch()" id="aiSearchToggle">
                        <i class="fas fa-search"></i>
                        <span>Search with AI</span>
                    </div>
                </div>
                
                <button class="cart-icon" id="cartButton">🛒 Cart (0)</button>
               <a href="{% url 'shop:choose_creation' %}" class="btn btn-primary">Add Product</a>

            </div>

            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDarkNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasDarkNavbar">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title">Fashion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Products</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Limited Offer</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Blogs</a>
                        </li>
                    </ul>
                    
                    <!-- Mobile AI Search -->
                    <div class="mt-3">
                        <div class="ai-search-toggle" onclick="toggleAISearch()" style="width: 100%; justify-content: center;">
                            <i class="fas fa-search"></i>
                            <span>Search with AI</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Home Section -->
    <div id="carouselExampleInterval" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active" data-bs-interval="10000">
                <img src="{% static 'shop/images/pic1.png' %}" class="d-block w-100" alt="Fashion Banner 1">
            </div>
            <div class="carousel-item" data-bs-interval="2000">
                <img src="{% static 'shop/images/pic2.png' %}" class="d-block w-100" alt="Fashion Banner 2">
            </div>
            <div class="carousel-item">
                <img src="{% static 'shop/images/pic3.png' %}" class="d-block w-100" alt="Fashion Banner 3">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleInterval" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleInterval" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>

    <!-- Error/Success Messages -->
    {% if error_message %}
    <div class="container my-4">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> {{ error_message }}
        </div>
    </div>
    {% endif %}

    {% if success_message %}
    <div class="container my-4">
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> {{ success_message }}
        </div>
    </div>
    {% endif %}

    {% if message %}
    <div class="container my-4">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> {{ message }}
        </div>
    </div>
    {% endif %}

    <!-- Why Shop With Us -->
    <div class="container text-center my-5">
        <div class="row">
            <div class="headline text-center mb-5">
                <h2 class="pb-3 position-relative d-inline-block">Why Shop With Us</h2>
            </div>
            <div class="col-12 col-md-4 mb-4">
                <div class="feature-box p-4 h-100">
                    <i class="fa-solid fa-truck fs-3 mb-3"></i>
                    <h2 class="fw-normal mt-2">Free Shipping</h2>
                    <p class="fw-lighter mt-2">Far far away, behind the word mountains, far from the countries.</p>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-4">
                <div class="feature-box p-4 h-100">
                    <i class="fa-solid fa-rotate fs-3 mb-3"></i>
                    <h2 class="fw-normal mt-2">Simple Returns</h2>
                    <p class="fw-lighter mt-2">Far far away, behind the word mountains, far from the countries.</p>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-4">
                <div class="feature-box p-4 h-100">
                    <i class="fa-solid fa-lock fs-3 mb-3"></i>
                    <h2 class="fw-normal mt-2">Secure Payments</h2>
                    <p class="fw-lighter mt-2">Far far away, behind the word mountains, far from the countries.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Product Retrieval Section -->
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card" style="border: none; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08);">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-robot"></i> AI Product Retrieval System
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">Click the button below to retrieve and display products from the last AI agent response:</p>
                        <button id="retrieve-products-btn" class="btn btn-primary btn-lg">
                            <i class="fas fa-search"></i> Retrieve & Display Products
                        </button>
                        <div id="loading-indicator" class="mt-3" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Processing agent response...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Section -->
    <section id="products" class="products py-5">
        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <div class="headline text-center mb-5">
                        <h2 class="pb-3 position-relative d-inline-block">FEATURED PRODUCTS</h2>
                    </div>
                </div>
            </div>
            
            <input type="text" class="form-control search-bar" placeholder="Search products..." id="searchInput" style="max-width: 500px; margin: 0 auto 40px; border-radius: 50px; padding: 15px 25px;">
            
            <div class="row" id="productRow">
                {% for product in products %}
               <div class="col-sm-6 col-lg-4">
                    <div class="product-card">
                        {% if product.image %}
                        <div class="product-image" style="background-image: url('{{ product.image.url }}');">
                        </div>
                        {% else %}
                        <div class="product-image" style="background-image: url('{% static 'shop/images/placeholder.png' %}');">
                        </div>
                        {% endif %}
                        <div class="product-info">
                            <div class="product-category">Fashion</div>
                            <div class="product-name">{{ product.name }}</div>
                            {% if product.price %}
                                <div class="product-price">${{ product.price }}</div>
                            {% endif %}
                            <div class="product-id">ID: {{ product.product_id }}</div>
                            {% if product.description %}
                                <div class="product-description">{{ product.description }}</div>
                            {% else %}
                                <div class="product-description">No description</div>
                            {% endif %}
                            <button class="add-to-cart" onclick="addToCart('{{ product.product_id }}', '{{ product.name }}', '{{ product.price }}')">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not products %}
                <div class="col-12 text-center">
                    <div class="loading">🤖 AI is loading products...</div>
                </div>
                {% endif %}
            </div> 
        </div>
    </section>

    <!-- Agent Retrieved Products Display Section -->
    {% if show_products and product_list %}
    <div class="container my-5" id="retrieved-products-section">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h2 class="display-6">
                        <i class="fas fa-boxes text-primary"></i> AI Retrieved Products
                        <span class="badge bg-success ms-2">{{ product_list|length }}</span>
                    </h2>
                    <p class="lead text-muted">Products found and displayed by our AI agent</p>
                </div>
            </div>
        </div>
        
        <div class="row g-4">
            {% for product in product_list %}
            <div class="col-lg-4 col-md-6">
                <div class="card product-card h-100">
                    {% if product.image_url %}
                        <img src="{{ product.image_url }}" class="card-img-top product-image" alt="{{ product.name }}" style="height: 220px; object-fit: cover;">
                    {% else %}
                        <div class="card-img-top d-flex align-items-center justify-content-center" style="height: 220px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                    {% endif %}
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title" style="font-family: 'Playfair Display', serif; font-weight: 600;">{{ product.name }}</h5>
                        <div class="mb-3" style="border-bottom: 1px solid #f1f3f4; padding-bottom: 10px;">
                            <p class="card-text text-muted small mb-1">
                                <strong>Product ID:</strong> {{ product.product_id }}
                            </p>
                            {% if product.found_by %}
                            <p class="card-text text-muted small mb-0">
                                <strong>Found by:</strong> {{ product.found_by }}
                            </p>
                            {% endif %}
                        </div>
                        <p class="card-text">{{ product.description|truncatewords:20 }}</p>
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="h4 mb-0 text-primary" style="color: #667eea !important; font-weight: 700;">${{ product.price }}</span>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" style="border-radius: 8px;">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-primary btn-sm ms-1" style="border-radius: 8px;" onclick="addToCart('{{ product.product_id }}', '{{ product.name }}', '{{ product.price }}')">
                                        <i class="fas fa-cart-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">
                            <i class="fas fa-robot"></i> Retrieved by AI Agent
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Image Upload Modal -->
    <div class="modal fade" id="imageUploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Product Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Please select an image for the product:</p>
                    <input id="fileInput" type="file" accept="image/*" class="form-control">
                    <div id="fileName" class="mt-2 text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadImageBtn">Upload Image</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let cart = [];
        let lastProductId = null;
        let imageUploadModal;

        // Initialize modal
        document.addEventListener('DOMContentLoaded', function() {
            imageUploadModal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
            initializeEventListeners();
        });

        // Event Listeners
        function initializeEventListeners() {
            // Retrieve products button
            const retrieveBtn = document.getElementById('retrieve-products-btn');
            if (retrieveBtn) {
                retrieveBtn.addEventListener('click', function() {
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Retrieving...';
                    this.disabled = true;
                    document.getElementById('loading-indicator').style.display = 'block';
                    
                    fetch('{% url "shop:trigger_retrieve" %}', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => response.text())
                    .then(html => {
                        document.documentElement.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error retrieving products. Please try again.');
                        this.innerHTML = '<i class="fas fa-search"></i> Retrieve & Display Products';
                        this.disabled = false;
                        document.getElementById('loading-indicator').style.display = 'none';
                    });
                });
            }

            // File input change
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    const fileName = document.getElementById('fileName');
                    if (this.files.length > 0) {
                        fileName.textContent = 'Selected: ' + this.files[0].name;
                    } else {
                        fileName.textContent = '';
                    }
                });
            }

            // Upload image button
            const uploadBtn = document.getElementById('uploadImageBtn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', uploadImage);
            }

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    filterProducts(searchTerm);
                });
            }
        }

        // AI Search Functions
        function toggleAISearch() {
            const panel = document.getElementById('aiSearchPanel');
            const overlay = document.getElementById('blurOverlay');
            const isActive = panel.classList.contains('active');
            
            if (isActive) {
                closeAISearch();
            } else {
                panel.classList.add('active');
                overlay.classList.add('active');
                document.getElementById('aiSearchInput').focus();
            }
        }

        function closeAISearch() {
            const panel = document.getElementById('aiSearchPanel');
            const overlay = document.getElementById('blurOverlay');
            panel.classList.remove('active');
            overlay.classList.remove('active');
        }

        function quickSearch(query) {
            document.getElementById('aiSearchInput').value = query;
            sendAIMessage();
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiSearchInput');
            const message = input.value.trim();
            
            if (!message) return;

            const responseContainer = document.getElementById('aiResponseContainer');
            const responseContent = document.getElementById('aiResponseContent');
            
            // Show loading state
            responseContainer.classList.add('active');
            responseContent.innerHTML = `
                <div class="ai-typing">
                    <i class="fas fa-robot"></i>
                    <span>AI is thinking...</span>
                    <div class="ai-typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('{% url "shop:chat" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                if (data.error) {
                    responseContent.innerHTML = `
                        <div style="color: #e74c3c;">
                            <h4>⚠️ Error</h4>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }

                // Display agent response
                const agentMessage = data.agent_output?.agent_message || 'No response from AI';
                responseContent.innerHTML = `
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 15px;">🤖 AI Response</h4>
                        <p>${agentMessage}</p>
                    </div>
                `;

                // Handle product creation trigger
                if (data.trigger_upload && data.product_id) {
                    lastProductId = data.product_id;
                    closeAISearch();
                    imageUploadModal.show();
                }

                input.value = '';
                
            } catch (error) {
                console.error('Chat error:', error);
                responseContent.innerHTML = `
                    <div style="color: #e74c3c;">
                        <h4>⚠️ Error</h4>
                        <p>Failed to communicate with AI. Please try again.</p>
                    </div>
                `;
            }
        }

        // Image Upload Function
        async function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file || !lastProductId) {
                alert('Please select a file first.');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);
            formData.append('product_id', lastProductId);

            try {
                const response = await fetch('{% url "shop:chat" %}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('Image uploaded successfully!');
                    imageUploadModal.hide();
                    fileInput.value = '';
                    document.getElementById('fileName').textContent = '';
                    location.reload(); // Refresh to show updated product
                } else {
                    alert('Error uploading image: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image. Please try again.');
            }
        }

        // Cart Functions
        function addToCart(productId, productName, productPrice) {
            cart.push({ id: productId, name: productName, price: productPrice });
            updateCartCounter();
            showNotification(`${productName} added to cart!`);
        }

        function updateCartCounter() {
            const cartButton = document.getElementById('cartButton');
            if (cartButton) {
                cartButton.textContent = `🛒 Cart (${cart.length})`;
                cartButton.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    cartButton.style.transform = 'scale(1)';
                }, 200);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2ecc71;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInFromRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutToRight 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Product Search Function
        function filterProducts(searchTerm) {
            const productCards = document.querySelectorAll('#productRow .product-card');
            
            productCards.forEach(card => {
                const productName = card.querySelector('.product-name')?.textContent.toLowerCase() || '';
                const productDescription = card.querySelector('.product-description')?.textContent.toLowerCase() || '';
                
                if (productName.includes(searchTerm) || productDescription.includes(searchTerm)) {
                    card.parentElement.style.display = 'block';
                } else {
                    card.parentElement.style.display = 'none';
                }
            });
        }

        // Utility Functions
        function getCsrfToken() {
            const metaToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (metaToken) return metaToken;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (csrfToken) return csrfToken;
            
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') return value;
            }
            
            return '';
        }

        // AI Search Input Enter Key Handler
        document.addEventListener('DOMContentLoaded', function() {
            const aiSearchInput = document.getElementById('aiSearchInput');
            if (aiSearchInput) {
                aiSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        sendAIMessage();
                    }
                });
            }
        });

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInFromRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutToRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>